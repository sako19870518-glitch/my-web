<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>スケール変換</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14/dist/handsontable.full.min.css" />
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--muted:#667085;--border:#e5e7eb;}
    html,body{height:100%}
    body{margin:0;padding:16px;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif}
    .wrap{max-width:1200px;margin:0 auto}
    h1{font-size:1.1rem;margin:0 0 12px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 12px}
    .toolbar button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .toolbar button.primary{background:#111;color:#fff;border-color:#111}
    .status{font-size:.9rem;color:var(--muted)}
    #grid{height:70vh;}
    .hidden{display:none}
  </style>
</head>
<body>
<div class="wrap">
  <h1>スケール変換</h1>
  <div class="card">
    <div class="toolbar">
      <span class="status" id="status">読み込み準備中…</span>
      <button id="reloadBtn" class="primary hidden">再読み込み</button>
      <button id="exportBtn" class="hidden">このシートを .xlsx として保存</button>
    </div>
    <div id="grid"></div>
    <div class="status" style="margin-top:8px">※ book.xlsx を自動読み込みします。</div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/hyperformula@2.7.1/dist/hyperformula.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable@14/dist/handsontable.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  const STATUS = document.getElementById('status');
  const RELOAD = document.getElementById('reloadBtn');
  const EXPORT = document.getElementById('exportBtn');
  const GRID = document.getElementById('grid');
  let hf = null, hot = null, currentSheetName = 'Sheet1';

  function setStatus(msg){ STATUS.textContent = msg; }
  function show(el){ el.classList.remove('hidden'); }
  function mountGrid(data){
    if(hf){ try{ hf.destroy(); }catch(e){} }
    hf = HyperFormula.HyperFormula.buildEmpty({ licenseKey: 'gpl-v3' });
    if(hot){ hot.destroy(); }
    hot = new Handsontable(GRID, {
      data,
      rowHeaders: true,
      colHeaders: true,
      contextMenu: true,
      width: '100%',
      height: GRID.clientHeight,
      licenseKey: 'non-commercial-and-evaluation',
      formulas: { engine: hf },
      manualColumnResize:true,
      manualRowResize:true,
      stretchH:'all'
    });
  }

  function sheetTo2DArray(ws){
    const range = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : { s:{r:0,c:0}, e:{r:50,c:20} };
    const rows = [];
    for(let R=range.s.r; R<=range.e.r; R++){
      const row = [];
      for(let C=range.s.c; C<=range.e.c; C++){
        const addr = XLSX.utils.encode_cell({r:R,c:C});
        const cell = ws[addr];
        if(!cell){ row.push(''); continue; }
        if(cell.f) row.push('=' + cell.f);
        else row.push(cell.v ?? '');
      }
      rows.push(row);
    }
    return rows;
  }

  async function fetchWorkbook(){
    setStatus('book.xlsx を読み込み中…');
    try{
      const res = await fetch('book.xlsx', { cache: 'no-cache' });
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type:'array', cellFormula:true, cellDates:true });
      const first = wb.SheetNames[0];
      currentSheetName = first;
      const data = sheetTo2DArray(wb.Sheets[first]);
      mountGrid(data);
      setStatus('読み込み完了：' + first);
      show(RELOAD); show(EXPORT);
    }catch(err){ setStatus('book.xlsx が見つかりません'); }
  }

  RELOAD.addEventListener('click', fetchWorkbook);
  EXPORT.addEventListener('click', ()=>{
    const data = hot.getData();
    const ws = {};
    const R=data.length, C=data[0]?data[0].length:0;
    for(let r=0;r<R;r++){
      for(let c=0;c<C;c++){
        const v = data[r][c];
        const addr = XLSX.utils.encode_cell({r,c});
        if(typeof v==='string' && v.startsWith('=')) ws[addr]={t:'n', f:v.slice(1)};
        else if(v===''||v==null){} else if(typeof v==='number') ws[addr]={t:'n',v};
        else ws[addr]={t:'s',v:String(v)};
      }
    }
    if(R>0&&C>0) ws['!ref'] = XLSX.utils.encode_range({s:{r:0,c:0}, e:{r:R-1,c:C-1}});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, currentSheetName||'Sheet1');
    XLSX.writeFile(wb, (currentSheetName||'sheet') + '_edited.xlsx');
  });

  fetchWorkbook();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js');
  }
</script>
</body>
</html>
